<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>粒子圣诞树 2025｜Merry Christmas</title>
<style>
    body { margin:0; overflow:hidden; background:#000; }
    canvas { display:block; }
    .tip {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font: bold 24px Arial;
        pointer-events: none;
        opacity: 0;
        text-shadow: 0 0 20px #fff;
    }
</style>
</head>
<body>

<canvas id="canvas"></canvas>
<div class="tip" id="tip">点击屏幕再次观看</div>

<script>
// ================ 粒子圣诞树主程序 ================
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
let w, h, particles = [], targetPoints = [], state = 'countdown';

canvas.width = w = window.innerWidth;
canvas.height = h = window.innerHeight;

window.addEventListener('resize', () => {
    canvas.width = w = window.innerWidth;
    canvas.height = h = window.innerHeight;
});

// 粒子类
class Particle {
    constructor(x, y, color = '#fff') {
        this.x = x;
        this.y = y;
        this.targetX = x;
        this.targetY = y;
        this.color = color;
        this.size = Math.random() * 3 + 1;
        this.speed = 0.06 + Math.random() * 0.08;
        this.vx = (Math.random() - 0.5) * 8;
        this.vy = (Math.random() - 0.5) * 8;
    }
    update() {
        if (state === 'explode') {
            this.x += this.vx;
            this.y += this.vy;
            this.vy += 0.15; // 重力
        } else {
            const dx = this.targetX - this.x;
            const dy = this.targetY - this.y;
            this.x += dx * this.speed;
            this.y += dy * this.speed;
        }
    }
    draw() {
        ctx.save();
        ctx.globalAlpha = 1;
        ctx.fillStyle = this.color;
        ctx.shadowBlur = 15;
        ctx.shadowColor = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
        ctx.fill();
        ctx.restore();
    }
}

// 生成数字的点阵（3、2、1）
function generateNumberPoints(num, scale = 8) {
    const points = [];
    const fontSize = 200;
    ctx.font = `bold ${fontSize}px Arial`;
    ctx.fillText(num, 100, 200);
    const data = ctx.getImageData(0,0,400,300).data;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    for (let y = 0; y < 300; y += scale) {
        for (let x = 0; x < 400; x += scale) {
            const i = (y * 400 + x) * 4;
            if (data[i + 3] > 128) {
                points.push({
                    x: x + (w - 400)/2,
                    y: y + (h - 300)/2 + 50
                });
            }
        }
    }
    return points;
}

// 圣诞树点阵（手工绘制，超级漂亮）
function generateTreePoints() {
    const points = [];
    const cx = w / 2;
    const cy = h / 2 + 50;

    // 五角星
    for (let i = 0; i < 300; i++) {
        const angle = (Math.PI * 2 * i) / 300;
        const r = Math.random() * 40;
        const starAngle = angle * 5;
        points.push({
            x: cx + Math.cos(starAngle) * r,
            y: cy - 220 + Math.sin(starAngle) * r,
            color: '#ffff00'
        });
    }

    // 四层树
    const layers = [
        { y: cy - 120, width: 320, color: '#00ff00' },
        { y: cy - 40,  width: 400, color: '#00cc00' },
        { y: cy + 40,  width: 500, color: '#009900' },
        { y: cy + 130, width: 600, color: '#006600' }
    ];

    layers.forEach(layer => {
        const count = Math.floor(layer.width * 1.2);
        for (let i = 0; i < count; i++) {
            const angle = (Math.PI * i) / (count / 2) - Math.PI / 2;
            const dist = Math.random() * (layer.width / 2);
            points.push({
                x: cx + Math.cos(angle) * dist,
                y: layer.y + Math.sin(angle) * dist * 0.6,
                color: layer.color
            });
        }
    });

    // 树干
    for (let i = 0; i < 800; i++) {
        points.push({
            x: cx + (Math.random() - 0.5) * 80,
            y: cy + 180 + Math.random() * 140,
            color: '#8B4513'
        });
    }

    // 彩灯（随机闪烁）
    const colors = ['#ff0000','#00ff00','#0000ff','#ffff00','#ff00ff','#00ffff'];
    for (let i = 0; i < 200; i++) {
        points.push({
            x: cx + (Math.random() - 0.5) * 500,
            y: cy - 150 + Math.random() * 400,
            color: colors[Math.floor(Math.random() * colors.length)],
            light: true
        });
    }

    return points;
}

// 开始倒计时
let countdownNum = 3;
function startCountdown() {
    state = 'countdown';
    particles = [];
    targetPoints = generateNumberPoints(countdownNum);

    targetPoints.forEach(p => {
        const color = `hsl(${Math.random()*60 + 340}, 100%, 60%)`; // 红色到粉色系
        particles.push(new Particle(
            Math.random() * w,
            Math.random() * h,
            color
        ));
    });

    setTimeout(() => {
        if (countdownNum > 1) {
            countdownNum--;
            startCountdown();
        } else {
            setTimeout(startTree, 800);
        }
    }, 1800);
}

function startTree() {
    state = 'forming';
    targetPoints = generateTreePoints();

    // 爆炸效果
    particles.forEach(p => {
        p.vx = (Math.random() - 0.5) * 20;
        p.vy = Math.random() * -15 - 5;
    });
    state = 'explode';

    setTimeout(() => {
        state = 'tree';
        // 重新分配目标点
        particles.forEach((p, i) => {
            const target = targetPoints[i % targetPoints.length];
            p.targetX = target.x;
            p.targetY = target.y;
            p.color = target.color || '#00ff00';
        });
    }, 1200);
}

// 动画循环
function animate() {
    ctx.fillStyle = 'rgba(0,0,0,0.08)';
    ctx.fillRect(0,0,w,h);

    particles.forEach(p => {
        p.update();
        p.draw();
    });

    // 彩灯闪烁
    if (state === 'tree') {
        particles.filter(p => p.light).forEach(p => {
            p.color = Math.random() > 0.97 
                ? `hsl(${Math.random()*360},100%,70%)` 
                : p.color;
        });
    }

    requestAnimationFrame(animate);
}

// 飘雪粒子
setInterval(() => {
    if (state === 'tree') {
        const snow = new Particle(
            Math.random() * w,
            -10,
            'rgba(255,255,255,0.8)'
        );
        snow.size = Math.random() * 3 + 1;
        snow.speed = 0.02;
        snow.vy = Math.random() * 2 + 1;
        particles.push(snow);
    }
}, 100);

// 点击重新播放
canvas.addEventListener('click', () => {
    document.getElementById('tip').style.opacity = 0;
    countdownNum = 3;
    startCountdown();
});

// 启动
startCountdown();
animate();

// 显示提示
setTimeout(() => {
    document.getElementById('tip').style.opacity = 1;
}, 10000);
</script>
</body>
</html>